pid                     /var/run/nginx.pid;
user                    www-data;
worker_processes        auto;
worker_rlimit_nofile    10024;

events {
    use                 epoll;
    multi_accept        on;
    worker_connections  1024;
}

http {
    server_tokens       off;
    keepalive_timeout   65;
    keepalive_requests  100000;
    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;

    client_max_body_size        20m;
    client_body_buffer_size     128k;

    # Closing Slow Connections
    client_body_timeout         30s;
    client_header_timeout       30s;

    client_header_buffer_size   1k;

    large_client_header_buffers 4 4k;
    output_buffers              1 32k;
    postpone_output             1460;
    send_timeout                3m;

    open_file_cache             max=1000 inactive=20s;
    open_file_cache_valid       30s;
    open_file_cache_min_uses    5;
    open_file_cache_errors      off;

    include         /etc/nginx/mime.types;
    default_type    application/octet-stream;

    gzip            on;
    gzip_min_length 1000;
    gzip_buffers    4 4k;
    gzip_types      text/css text/javascript text/plain text/xml application/x-javascript application/javascript application/json application/vnd.ms-fontobject application/x-font-opentype application/x-font-truetype application/x-font-ttf application/xml font/eot font/opentype font/otf image/svg+xml image/vnd.microsoft.icon;
    gzip_disable    "MSIE [1-6]\.";

    limit_conn limit_per_ip 10;
    limit_conn_zone $binary_remote_addr zone=limit_per_ip:10m;

    upstream backend {
        server 127.0.0.1:8080;
    }

    proxy_cache_path /etc/nginx/proxy_cache levels=1:2 keys_zone=super-speed-nginx:10m max_size=10g inactive=60m use_temp_path=off;
    proxy_cache_path /etc/nginx/download_cache levels=1:2 keys_zone=download:20m inactive=24h max_size=100m;
    proxy_cache_path /etc/nginx/media_cache levels=1:2 keys_zone=media_resolve:20m inactive=24h max_size=100m;

    map $http_user_agent $limit_bots {
         default 0;
         ~*(google|bing|yandex|msnbot) 1;
         ~*(AltaVista|Googlebot|Slurp|BlackWidow|Bot|ChinaClaw|Custo|DISCo|Download|Demon|eCatch|EirGrabber|EmailSiphon|EmailWolf|SuperHTTP|Surfbot|WebWhacker) 1;
         ~*(Express|WebPictures|ExtractorPro|EyeNetIE|FlashGet|GetRight|GetWeb!|Go!Zilla|Go-Ahead-Got-It|GrabNet|Grafula|HMView|Go!Zilla|Go-Ahead-Got-It) 1;
         ~*(rafula|HMView|HTTrack|Stripper|Sucker|Indy|InterGET|Ninja|JetCar|Spider|larbin|LeechFTP|Downloader|tool|Navroad|NearSite|NetAnts|tAkeOut|WWWOFFLE) 1;
         ~*(GrabNet|NetSpider|Vampire|NetZIP|Octopus|Offline|PageGrabber|Foto|pavuk|pcBrowser|RealDownload|ReGet|SiteSnagger|SmartDownload|SuperBot|WebSpider) 1;
         ~*(Teleport|VoidEYE|Collector|WebAuto|WebCopier|WebFetch|WebGo|WebLeacher|WebReaper|WebSauger|eXtractor|Quester|WebStripper|WebZIP|Wget|Widow|Zeus) 1;
         ~*(Twengabot|htmlparser|libwww|Python|perl|urllib|scan|Curl|email|PycURL|Pyth|PyQ|WebCollector|WebCopy|webcraw) 1;
    }

    server {
        listen      80 default_server;
        server_name 127.0.0.1;
        root        /var/www/current/web;

        sendfile            off;

        access_log  /var/log/nginx/access.log;
        error_log   /var/log/nginx/error.log;

        location /media/cache/resolve/ {
            proxy_pass          http://backend;
            proxy_set_header    X-Real-IP  $remote_addr;
        }

        location /media/download/ {
            proxy_pass          http://backend;
            proxy_set_header    X-Real-IP  $remote_addr;
            proxy_cache         download;
            proxy_cache_valid   200 7d;
        }

        location /assets/ {
            alias           /var/www/current/web/assets/;
            access_log      off;
            log_not_found   off;
            expires         0d;
            add_header      pragma public;
            add_header      cache-control "public";
        }

        location /media/ {
            alias           /var/www/current/web/media/;
            access_log      off;
            log_not_found   off;
            expires         1d;
            add_header      pragma public;
            add_header      cache-control "public";
        }

        location /media/cache/ {
            alias           /var/www/current/web/media/cache/;
            access_log      off;
            log_not_found   off;
            expires         1d;
            add_header      pragma public;
            add_header      cache-control "public";
        }

        location /robots.txt {
            root            /var/www/current/web/;
            access_log      off;
            log_not_found   off;
        }

        location /favicon.ico {
            root            /var/www/current/web/;
            access_log      off;
            log_not_found   off;
        }

        #location ~* .(woff|eot|ttf|svg|mp4|webm|jpg|jpeg|png|gif|ico|css|js)$ {
        #    expires 1d;
        #}

        location / {
            #if ($limit_bots = 1) {
            #    return 403;
            #}

            proxy_pass          http://backend;
            proxy_redirect      off;

            proxy_set_header    Host                    $host;
            proxy_set_header    X-Real-IP               $remote_addr;
            proxy_set_header    X-Forwarded-For         $proxy_add_x_forwarded_for;
            proxy_set_header    X-Forwarded-Proto       http;

            proxy_connect_timeout       90;
            proxy_send_timeout          90;
            proxy_read_timeout          90;
            proxy_buffer_size           4k;
            proxy_buffers               4 32k;
            proxy_busy_buffers_size     64k;
            proxy_temp_file_write_size  64k;
            proxy_temp_path            /etc/nginx/proxy_temp;
        }
    }

    # Virtual Host Configs
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
